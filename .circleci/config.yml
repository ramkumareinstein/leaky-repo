version: '2.1'
orbs:
  slack: circleci/slack@4.1
  jq: circleci/jq@2.2.0
jobs:
  talisman:
    docker:
      - image: rameinstein/talisman:talisman
        auth:
          username: rameinstein  # can specify string literal values
          password: ygvBHU@3690
    environment:
      TALISMAN_HOME: /root/.talisman/bin
      TALISMAN_INTERACTIVE: false
    steps:
      - checkout
      - jq/install
      - run:
          name: Check Talisman
          command: $TALISMAN_HOME/talisman_linux_amd64 --scan || echo "done" # I've added --ignoreHistory to the end here 
      - store_artifacts:
          path: talisman_report/talisman_reports/data
          destination: talisman_report
      - run:
          name: Get artifacts
          command: |
            export ARTIFACT_URL=$(curl -X GET "https://circleci.com/api/v2/project/github/ramkumareinstein/leaky-repo/$CIRCLE_BUILD_NUM/artifacts" \
            -H "Accept: application/json" \
            -u "$CIRCLE_API_TOKEN:" | jq ".items[].url")
            echo $ARTIFACT_URL
            # generate a heredoc in BASH_ENV
            # the '\<<' is a CircleCI escape
            echo "read -r -d '' STORED_ARTIFACTS \<< 'EOF_ARTIFACTS'" >> $BASH_ENV
            echo "export $ARTIFACT_URL" >> $BASH_ENV
            echo "EOF_ARTIFACTS" >> $BASH_ENV
            
      - slack/notify:               
                custom: |
                    {
                     	"blocks": 
                      [
                          {
                        			"type": "header",
                        			"text": {
                        				"type": "plain_text",
                        				"text": "Job Succeeded. :white_check_mark:",
                        				"emoji": true
                        			}
                        		},
                        		{
                        			"type": "section",
                        			"fields": [
                        				{
                        					"type": "mrkdwn",
                        					"text": "*Job*: ${CIRCLE_JOB}"
                        				}
                        			]
                        		},
                       {
                        "type": "actions",
                        			"elements": [
                        				{
                        					"type": "button",
                        					"action_id": "basic_success_view",
                        					"text": {
                        						"type": "plain_text",
                        						"text": "View Artifact"
                        					},
                        					"url": "${ARTIFACT_URL}"
                        				}
                        			]
                        }
                      ] 
                    }
                event: always
           
workflows:
  send-notification:
    jobs:
      - talisman
